# Database Schema Documentation

## Overview
This document describes the database schema for the AI Accounting Job Matching project. The database is shared with accountingfirmjobs.com, so special care must be taken when making any schema changes.

## Tables

### Users (`users`)
Stores user information and preferences.

```sql
CREATE TABLE users (
    id           integer PRIMARY KEY,
    telegram_id  bigint NOT NULL UNIQUE,
    username     varchar,
    first_name   varchar,
    last_name    varchar,
    cv_text      text,
    cv_embedding jsonb,
    preferences  jsonb,
    created_at   timestamptz NOT NULL,
    updated_at   timestamptz NOT NULL,
    last_active  timestamptz DEFAULT now()
);

-- Indexes
CREATE INDEX users_telegram_id_key ON users(telegram_id);
```

### Jobs (`JobsApp_job`)
Stores job listings from accounting firms. Note that job embeddings are stored in a separate `job_embeddings` table.

```sql
CREATE TABLE "JobsApp_job" (
    id                   bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    job_title            varchar(1000) NOT NULL,
    seniority            varchar(1000) NOT NULL,
    service              varchar(1000) NOT NULL,
    industry             varchar(1000) NOT NULL,
    location             varchar(5000) NOT NULL,
    employment           varchar(1000) NOT NULL,
    salary               varchar(1000) NOT NULL,
    description          text NOT NULL,
    link                 varchar(400) NOT NULL,
    req_no               varchar(1000) NOT NULL,
    date_published       varchar(1000),
    created_at           date NOT NULL,
    updated_at           date NOT NULL,
    firm_id              bigint NOT NULL REFERENCES "JobsApp_accountingfirm"(id),
    location_coordinates varchar(5000) NOT NULL,
    scrapped_industry    varchar(1000) NOT NULL,
    scrapped_seniority   varchar(1000) NOT NULL,
    scrapped_service     varchar(1000) NOT NULL,
    slug                 varchar(6000) NOT NULL,
    is_indexed          boolean NOT NULL
);

-- Indexes
CREATE INDEX JobsApp_job_firm_id_12e7e041 ON "JobsApp_job"(firm_id);
```

### Job Embeddings (`job_embeddings`)
Stores vector embeddings for jobs, used for semantic similarity search.

```sql
CREATE TABLE job_embeddings (
    id               integer PRIMARY KEY,
    job_id           integer NOT NULL REFERENCES "JobsApp_job"(id),
    embedding        vector(1536),
    embedding_vector vector(1536),
    last_updated     timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE UNIQUE INDEX job_embeddings_job_id_key ON job_embeddings(job_id);
CREATE INDEX job_embedding_idx ON job_embeddings USING ivfflat (embedding vector_cosine_ops) WITH (lists='100');
```

### Job Matches (`job_matches`)
Stores matches between users and jobs with similarity scores.

```sql
CREATE TABLE job_matches (
    id          integer PRIMARY KEY,
    telegram_id bigint REFERENCES users(telegram_id),
    job_id      bigint REFERENCES "JobsApp_job"(id),
    score       float NOT NULL,
    created_at  timestamptz NOT NULL
);

-- Indexes
CREATE INDEX job_matches_telegram_id_idx ON job_matches(telegram_id);
CREATE INDEX job_matches_job_id_idx ON job_matches(job_id);
```

## Important Notes

1. **Vector Search**
   - Job embeddings are stored in the `job_embeddings` table using pgvector's vector type
   - Each job in `JobsApp_job` has a corresponding embedding in `job_embeddings`
   - The `job_embeddings` table uses an IVFFlat index for efficient similarity search
   - The similarity threshold is configurable via `VECTOR_SIMILARITY_THRESHOLD` in settings
   - Currently, 7,426 out of 7,635 jobs have embeddings

2. **Shared Database**
   - The database is shared with accountingfirmjobs.com
   - Tables prefixed with "JobsApp_" belong to the job board application
   - Never modify the schema of JobsApp_ tables without coordination
   - Our application only reads from JobsApp_ tables but never writes to them

3. **Data Types**
   - CV embeddings in users table are stored as JSONB for flexibility
   - Job embeddings in job_embeddings table use the vector type for efficient similarity search
   - Timestamps use timestamptz to handle timezone information properly

4. **Foreign Keys**
   - job_matches links to both users and jobs tables
   - Jobs link to accounting firms via firm_id
   - job_embeddings has a one-to-one relationship with JobsApp_job

5. **Performance Considerations**
   - The job_embedding_idx index uses IVFFlat for approximate nearest neighbor search
   - Key fields are indexed for efficient lookups
   - The vector index is configured with 100 lists for a good balance of speed and accuracy
   - Job similarity searches join JobsApp_job with job_embeddings for complete job information
